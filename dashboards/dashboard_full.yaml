views:
  - type: sections
    cards: []
    title: Scheduled charging
    sections:
      - type: grid
        cards:
          - type: custom:apexcharts-card
            header:
              show: true
              show_states: true
              colorize_states: true
            graph_span: 2d
            span:
              start: day
            now:
              show: true
              label: Now
            series:
              - entity: sensor.current_spot_electricity_price
                float_precision: 2
                type: column
                show:
                  in_header: raw
                data_generator: >
                  return Object.entries(entity.attributes).map(([date, value],
                  index) => {
                    return [new Date(date).getTime() + (30 * 60 * 1000), value];
                  });
          - type: gauge
            entity: sensor.current_spot_electricity_price
            name: Electricity Price
            unit: Kč/kWh
            needle: true
            min: -1
            max: 8
            segments:
              - from: -1
                color: '#43a047'
              - from: 1
                color: '#8bc34a'
              - from: 2.5
                color: '#fdd835'
              - from: 4
                color: '#fb8c00'
              - from: 6
                color: '#e53935'
      - type: grid
        cards:
          - type: vertical-stack
            cards:
              - type: entities
                title: Night Charging
                show_header_toggle: false
                entities:
                  - entity: sensor.smart_battery_charging_night_charging_status
                    name: Status
                  - entity: switch.smart_battery_charging_enabled
                    name: Automation Enabled
                  - entity: binary_sensor.smart_battery_charging_charging_active
                    name: Charging Now
              - type: glance
                title: Battery & Forecast
                columns: 3
                show_state: true
                entities:
                  - entity: sensor.solax_inverter_battery_capacity
                    name: Battery
                  - entity: sensor.smart_battery_charging_average_daily_consumption
                    name: Avg Use
                  - entity: sensor.smart_battery_charging_today_solar_forecast
                    name: Solar today
                    icon: mdi:weather-sunny
                  - entity: sensor.solax_inverter_today_s_solar_energy
                    name: Actual today
                    icon: mdi:solar-power
                  - entity: sensor.smart_battery_charging_tomorrow_solar_forecast
                    name: Solar tmrw
                  - entity: sensor.smart_battery_charging_solar_forecast_error_average
                    name: Fcst Error
                  - entity: sensor.smart_battery_charging_tomorrow_energy_forecast
                    name: Deficit
                  - entity: sensor.smart_battery_charging_electricity_price_status
                    name: Price
              - type: conditional
                conditions:
                  - condition: state
                    entity: sensor.smart_battery_charging_night_charging_status
                    state: Scheduled
                card:
                  type: entities
                  title: Tonight's Schedule
                  entities:
                    - entity: sensor.smart_battery_charging_night_charging_status
                      type: attribute
                      attribute: schedule_start
                      name: Start Hour
                      icon: mdi:clock-start
                    - entity: sensor.smart_battery_charging_night_charging_status
                      type: attribute
                      attribute: schedule_end
                      name: End Hour
                      icon: mdi:clock-end
                    - entity: sensor.smart_battery_charging_night_charging_status
                      type: attribute
                      attribute: charge_needed
                      name: Required Charge (kWh)
              - type: glance
                title: Last Night's Charge
                columns: 3
                show_state: true
                show_name: true
                entities:
                  - entity: sensor.smart_battery_charging_last_night_charge_kwh
                    name: Charged
                  - entity: sensor.smart_battery_charging_last_charge_battery_range
                    name: Battery
                    icon: mdi:battery-arrow-up
                  - entity: sensor.smart_battery_charging_last_charge_time_range
                    name: Time
                    icon: mdi:clock-outline
                  - entity: sensor.smart_battery_charging_last_charge_total_cost
                    name: Cost
      - type: grid
        cards:
          - graph: line
            type: sensor
            entity: sensor.smart_battery_charging_tomorrow_solar_forecast
            detail: 1
            grid_options:
              columns: 12
              rows: 2
            hours_to_show: 72
          - graph: line
            type: sensor
            entity: sensor.smart_battery_charging_average_daily_consumption
            detail: 1
            hours_to_show: 72
            grid_options:
              columns: 12
              rows: 2
          - graph: line
            type: sensor
            entity: sensor.smart_battery_charging_tomorrow_energy_forecast
            detail: 1
            hours_to_show: 72
            grid_options:
              columns: 12
              rows: 2
          - type: custom:apexcharts-card
            header:
              show: true
              show_states: true
              colorize_states: true
            graph_span: 7d
            span:
              end: day
            grid_options:
              columns: 12
            series:
              - entity: sensor.smart_battery_charging_last_night_charge_kwh
                type: column
                name: Night Charges
                float_precision: 1
                unit: ' kWh'
                color: '#4caf50'
                show:
                  in_header: true
                data_generator: >
                  const h = entity.attributes.history;
                  if (!h || !Array.isArray(h) || h.length === 0) return [];
                  const now = new Date();
                  return h.map((v, i) => {
                    const d = new Date(now);
                    d.setDate(d.getDate() - 1 - i);
                    d.setHours(12, 0, 0, 0);
                    return [d.getTime(), v];
                  }).reverse();
          - type: custom:apexcharts-card
            header:
              show: true
              show_states: true
              colorize_states: true
            graph_span: 7d
            span:
              end: day
            grid_options:
              columns: 12
            series:
              - entity: sensor.smart_battery_charging_solar_forecast_error_average
                type: column
                name: PV Forecast Error
                float_precision: 1
                unit: '%'
                color: '#ff9800'
                show:
                  in_header: true
                data_generator: >
                  const h = entity.attributes.history;
                  if (!h || !Array.isArray(h) || h.length === 0) return [];
                  const now = new Date();
                  return h.map((v, i) => {
                    const d = new Date(now);
                    d.setDate(d.getDate() - 1 - i);
                    d.setHours(12, 0, 0, 0);
                    return [d.getTime(), Math.round(v * 1000) / 10];
                  }).reverse();
          - type: custom:apexcharts-card
            header:
              show: true
              show_states: true
              colorize_states: true
            graph_span: 7d
            span:
              end: day
            grid_options:
              columns: 12
            series:
              - entity: sensor.smart_battery_charging_average_daily_consumption
                type: column
                name: Daily Consumption
                float_precision: 1
                unit: ' kWh'
                color: '#2196f3'
                show:
                  in_header: true
                data_generator: >
                  const h = entity.attributes.history;
                  if (!h || !Array.isArray(h) || h.length === 0) return [];
                  const now = new Date();
                  return h.map((v, i) => {
                    const d = new Date(now);
                    d.setDate(d.getDate() - 1 - i);
                    d.setHours(12, 0, 0, 0);
                    return [d.getTime(), v];
                  }).reverse();
    max_columns: 4
  - title: Data
    cards: []
    type: sections
    sections:
      - type: grid
        cards:
          - cardstyle: lite
            wide: true
            large_font: false
            show_solar: true
            show_battery: true
            show_grid: true
            center_no_grid: false
            card_height: 100%
            card_width: 100%
            decimal_places: 2
            decimal_places_energy: 1
            dynamic_line_width: false
            max_line_width: 4
            min_line_width: 1
            inverter:
              auto_scale: false
              modern: false
              model: solax
              three_phase: true
            battery:
              energy: 17600
              shutdown_soc: 11
              show_daily: true
              invert_power: true
              max_power: 10000
              auto_scale: false
              show_absolute: false
              hide_soc: false
            battery2:
              energy: 0
              shutdown_soc: 20
              soc_end_of_charge: 100
              invert_power: false
              hide_soc: false
              colour: '#ffc0cb'
              show_remaining_energy: true
              remaining_energy_to_shutdown: false
              show_absolute: false
              auto_scale: true
              dynamic_colour: true
              linear_gradient: true
              animate: true
              path_threshold: 100
              navigate: ''
              invert_flow: false
            solar:
              show_daily: true
              mppts: 2
              max_power: 9850
              display_mode: 2
              animation_speed: 9
              dynamic_colour: true
              pv1_name: West
              pv2_name: East
              auto_scale: false
              pv1_max_power: 4690
              pv2_max_power: 5160
              colour: '#f9ac06'
              invert_flow: false
            load:
              show_daily: true
              max_power: 15000
              show_aux: false
              show_nonessential: true
              additional_loads: 5
              load1_name: Softub
              load2_name: EV
              load1_icon: mdi:hot-tub
              load2_icon: mdi:ev-station
              animation_speed: 9
              load3_name: Rack
              load3_icon: mdi:server
              load4_name: AP
              load4_icon: mdi:wifi
              essential_name: Home
              invert_flow: false
              load5_name: Living
              load5_icon: mdi:sofa
              auto_scale: false
              load6_name: Floor
              load6_icon: mdi:heating-coil
              dynamic_icon: true
            grid:
              show_daily_buy: true
              show_daily_sell: true
              show_nonessential: false
              animation_speed: 9
              auto_scale: false
              export_colour: '#c206db'
              no_grid_colour: '#bdbcbc'
              invert_grid: true
            type: custom:sunsynk-power-flow-card
            entities:
              inverter_status_59: sensor.solax_inverter_run_mode
              inverter_voltage_154: sensor.solax_inverter_inverter_voltage_l1
              inverter_current_164: sensor.solax_inverter_inverter_current_l1
              inverter_power_175: sensor.solax_inverter_inverter_power
              radiator_temp_91: sensor.solax_inverter_inverter_temperature
              day_battery_charge_70: sensor.solax_inverter_battery_input_energy_today
              day_battery_discharge_71: sensor.solax_inverter_battery_output_energy_today
              battery_voltage_183: sensor.solax_inverter_battery_voltage_charge
              battery_soc_184: sensor.solax_inverter_battery_capacity
              battery_power_190: sensor.solax_inverter_battery_power_charge
              battery_current_191: sensor.solax_inverter_battery_current_charge
              battery_temp_182: sensor.solax_inverter_battery_temperature
              day_grid_import_76: sensor.solax_inverter_today_s_import_energy
              day_grid_export_77: sensor.solax_inverter_today_s_export_energy
              grid_power_169: sensor.solax_inverter_measured_power
              day_load_energy_84: sensor.solax_inverter_today_s_yield
              day_pv_energy_108: sensor.solax_inverter_today_s_solar_energy
              pv1_power_186: sensor.solax_inverter_pv_power_1
              pv1_voltage_109: sensor.solax_inverter_pv_voltage_1
              pv1_current_110: sensor.solax_inverter_pv_current_1
              pv2_power_187: sensor.solax_inverter_pv_power_2
              pv2_voltage_111: sensor.solax_inverter_pv_voltage_2
              pv2_current_112: sensor.solax_inverter_pv_current_2
              remaining_solar: sensor.energy_production_today_remaining
              essential_load1: sensor.shellypmminig3_dcda0ce98f54_power
              day_aux_energy: sensor.solax_inverter_eps_yield_today
              essential_load3: sensor.shellyplusplugs_fcb467271384_switch_0_power
              essential_load4: sensor.ap_power_meter_power
              essential_load5: sensor.living_room_power
              inverter_voltage_L2: sensor.solax_inverter_inverter_voltage_l2
              inverter_voltage_L3: sensor.solax_inverter_inverter_voltage_l3
              inverter_current_L2: sensor.solax_inverter_inverter_current_l2
              inverter_current_L3: sensor.solax_inverter_inverter_current_l3
              grid_ct_power_total: sensor.solax_inverter_measured_power
              total_pv_generation: sensor.solax_inverter_total_solar_energy
              environment_temp: sensor.o_1pst_temperature
              essential_load2: sensor.solax_api_charge_power_total
            grid_options:
              columns: full
              rows: 6
      - type: grid
        cards:
          - title: Flow
            type: history-graph
            hours_to_show: 48
            entities:
              - entity: sensor.pv_power
              - entity: sensor.solax_inverter_pv_power_1
              - entity: sensor.solax_inverter_pv_power_2
              - entity: sensor.solax_inverter_battery_power_charge
              - entity: sensor.solax_inverter_measured_power
              - entity: sensor.softub_consumption
              - entity: sensor.solar_radiation_2
      - type: grid
        cards:
          - title: Battery
            type: history-graph
            hours_to_show: 48
            entities:
              - entity: sensor.smart_battery_charging_battery_charge_kwh
              - entity: sensor.solax_inverter_battery_capacity
    max_columns: 3
  - type: sections
    title: Analytics
    cards: []
    max_columns: 4
    sections:
      # ── Row 1: Solar Accuracy ──────────────────────────────────────────
      - type: grid
        cards:
          # Forecast vs Actual Solar — how accurate are predictions?
          - type: custom:apexcharts-card
            header:
              show: true
              title: "Solar: Forecast vs Actual"
              show_states: true
              colorize_states: true
            graph_span: 7d
            span:
              end: day
            yaxis:
              - id: kwh
                min: 0
                apex_config:
                  title:
                    text: kWh
            series:
              - entity: sensor.smart_battery_charging_today_solar_forecast
                name: Forecast
                type: line
                color: "#ff9800"
                stroke_width: 2
                yaxis_id: kwh
                group_by:
                  func: max
                  duration: 1d
                show:
                  in_header: raw
              - entity: sensor.solax_inverter_today_s_solar_energy
                name: Actual
                type: line
                color: "#4caf50"
                stroke_width: 2
                yaxis_id: kwh
                group_by:
                  func: max
                  duration: 1d
                show:
                  in_header: raw
            grid_options:
              columns: 12

          # Forecast Error Trend — is the correction working?
          - type: custom:apexcharts-card
            header:
              show: true
              title: Forecast Error Trend
              show_states: true
              colorize_states: true
            graph_span: 7d
            span:
              end: day
            yaxis:
              - id: pct
                apex_config:
                  title:
                    text: "%"
                  labels:
                    formatter: |
                      EVAL:function(val) { return val.toFixed(0) + '%'; }
            series:
              - entity: sensor.smart_battery_charging_today_solar_forecast_error
                name: Overestimate
                type: column
                color: "#ff9800"
                yaxis_id: pct
                group_by:
                  func: min
                  duration: 1d
                transform: "return x.map(p => [p[0], p[1] != null && p[1] >= 0 ? p[1] : null]);"
                show:
                  in_header: raw
              - entity: sensor.smart_battery_charging_today_solar_forecast_error
                name: Underestimate
                type: column
                color: "#4caf50"
                yaxis_id: pct
                group_by:
                  func: min
                  duration: 1d
                transform: "return x.map(p => [p[0], p[1] != null && p[1] < 0 ? p[1] : null]);"
                show:
                  in_header: false
              - entity: sensor.smart_battery_charging_solar_forecast_error_average
                name: 7d Average
                type: line
                color: "#f44336"
                stroke_width: 2
                yaxis_id: pct
                group_by:
                  func: avg
                  duration: 1d
                show:
                  in_header: raw
            grid_options:
              columns: 12

      # ── Row 2: Energy Balance ──────────────────────────────────────────
      - type: grid
        cards:
          # Daily Energy Balance — consumption vs solar vs grid charge
          - type: custom:apexcharts-card
            header:
              show: true
              title: Daily Energy Balance
              show_states: true
              colorize_states: true
            graph_span: 7d
            span:
              end: day
            yaxis:
              - id: kwh
                min: 0
                apex_config:
                  title:
                    text: kWh
            apex_config:
              chart:
                stacked: false
              plotOptions:
                bar:
                  columnWidth: "60%"
            series:
              - entity: sensor.smart_battery_charging_average_daily_consumption
                name: Consumption
                type: column
                color: "#f44336"
                yaxis_id: kwh
                show:
                  in_header: raw
                data_generator: >
                  const h = entity.attributes.history;
                  if (!h || !Array.isArray(h) || h.length === 0) return [];
                  const now = new Date();
                  return h.map((v, i) => {
                    const d = new Date(now);
                    d.setDate(d.getDate() - 1 - i);
                    d.setHours(12, 0, 0, 0);
                    return [d.getTime(), v];
                  }).reverse();
              - entity: sensor.smart_battery_charging_last_night_charge_kwh
                name: Grid Charge
                type: column
                color: "#9c27b0"
                yaxis_id: kwh
                show:
                  in_header: raw
                data_generator: >
                  const h = entity.attributes.history;
                  if (!h || !Array.isArray(h) || h.length === 0) return [];
                  const now = new Date();
                  return h.map((v, i) => {
                    const d = new Date(now);
                    d.setDate(d.getDate() - 1 - i);
                    d.setHours(12, 0, 0, 0);
                    return [d.getTime(), v];
                  }).reverse();
              - entity: sensor.solax_inverter_today_s_solar_energy
                name: Solar Actual
                type: column
                color: "#ff9800"
                yaxis_id: kwh
                group_by:
                  func: max
                  duration: 1d
                show:
                  in_header: raw
            grid_options:
              columns: 12

          # Charging Cost per Night
          - type: custom:apexcharts-card
            header:
              show: true
              title: Nightly Charging Cost
              show_states: true
              colorize_states: true
            graph_span: 14d
            span:
              end: day
            yaxis:
              - id: cost
                min: 0
                apex_config:
                  title:
                    text: cost
            series:
              - entity: sensor.smart_battery_charging_last_charge_total_cost
                name: Cost
                type: column
                color: "#e91e63"
                yaxis_id: cost
                float_precision: 1
                group_by:
                  func: max
                  duration: 1d
                show:
                  in_header: false
            grid_options:
              columns: 12

      # ── Row 3: Battery & Price ─────────────────────────────────────────
      - type: grid
        cards:
          # Battery SOC with Charging Windows
          - type: custom:apexcharts-card
            header:
              show: true
              title: Battery SOC (48h)
              show_states: true
              colorize_states: true
            graph_span: 48h
            yaxis:
              - id: soc
                min: 0
                max: 100
                apex_config:
                  title:
                    text: SOC %
              - id: active
                min: 0
                max: 1
                show: false
            now:
              show: true
              label: Now
            series:
              - entity: sensor.solax_inverter_battery_capacity
                name: Battery SOC
                type: area
                color: "#4caf50"
                yaxis_id: soc
                stroke_width: 2
                opacity: 0.15
                show:
                  in_header: raw
              - entity: binary_sensor.smart_battery_charging_charging_active
                name: Charging
                type: area
                curve: stepline
                color: "#9c27b0"
                yaxis_id: active
                stroke_width: 0
                opacity: 0.3
                transform: "return x === 'on' ? 1 : 0;"
                extend_to: end
                group_by:
                  func: last
                  duration: 5min
                  fill: last
                show:
                  in_header: false
                  legend_value: false
            apex_config:
              annotations:
                yaxis:
                  - y: 20
                    yAxisIndex: 0
                    borderColor: "#f44336"
                    strokeDashArray: 4
                    label:
                      text: Min SOC
                      style:
                        color: "#f44336"
                        background: "transparent"
            grid_options:
              columns: 12

          # Electricity Price with Charge Overlay (48h)
          - type: custom:apexcharts-card
            header:
              show: true
              title: Price & Charging (48h)
              show_states: true
              colorize_states: true
            graph_span: 48h
            yaxis:
              - id: price
                min: ~0
                apex_config:
                  title:
                    text: Price
              - id: active
                min: 0
                max: 1
                show: false
            now:
              show: true
              label: Now
            series:
              - entity: sensor.current_spot_electricity_price
                name: Price
                type: column
                color: "#2196f3"
                yaxis_id: price
                float_precision: 2
                show:
                  in_header: raw
              - entity: binary_sensor.smart_battery_charging_charging_active
                name: Charging
                type: area
                curve: stepline
                color: "#4caf50"
                yaxis_id: active
                stroke_width: 0
                opacity: 0.3
                transform: "return x === 'on' ? 1 : 0;"
                extend_to: end
                group_by:
                  func: last
                  duration: 5min
                  fill: last
                show:
                  in_header: false
                  legend_value: false
            apex_config:
              annotations:
                yaxis:
                  - y: 4
                    yAxisIndex: 0
                    borderColor: "#ff9800"
                    strokeDashArray: 4
                    label:
                      text: Price Threshold
                      style:
                        color: "#ff9800"
                        background: "transparent"
            grid_options:
              columns: 12

      # ── Row 4: Long-term Trends ────────────────────────────────────────
      - type: grid
        cards:
          # Grid Charging (30 days)
          - type: custom:apexcharts-card
            header:
              show: true
              title: Grid Charging (30d)
              show_states: true
              colorize_states: true
            graph_span: 30d
            span:
              end: day
            yaxis:
              - id: kwh
                min: 0
                apex_config:
                  title:
                    text: kWh
            series:
              - entity: sensor.smart_battery_charging_last_night_charge_kwh
                name: Nightly Charge
                type: column
                color: "#9c27b0"
                yaxis_id: kwh
                float_precision: 1
                group_by:
                  func: max
                  duration: 1d
                show:
                  in_header: false
            grid_options:
              columns: 12

          # Consumption Trend (30 days)
          - type: custom:apexcharts-card
            header:
              show: true
              title: Daily Consumption (30d)
              show_states: true
              colorize_states: true
            graph_span: 30d
            span:
              end: day
            yaxis:
              - id: kwh
                min: 0
                apex_config:
                  title:
                    text: kWh
            series:
              - entity: sensor.solax_energy_dashboard_solax_home_consumption_energy
                name: Consumption
                type: column
                color: "#2196f3"
                yaxis_id: kwh
                float_precision: 1
                group_by:
                  func: max
                  duration: 1d
                show:
                  in_header: raw
              - entity: sensor.smart_battery_charging_average_daily_consumption
                name: 7d Average
                type: line
                color: "#f44336"
                stroke_width: 2
                yaxis_id: kwh
                group_by:
                  func: avg
                  duration: 1d
                show:
                  in_header: raw
            grid_options:
              columns: 12

      # ── Row 5: Self-Consumption & Grid ───────────────────────────────────
      - type: grid
        cards:
          - type: gauge
            entity: sensor.smart_battery_charging_self_consumption_ratio
            name: Self Consumption
            unit: '%'
            needle: true
            min: 0
            max: 100
            segments:
              - from: 0
                color: '#e53935'
              - from: 30
                color: '#fb8c00'
              - from: 60
                color: '#fdd835'
              - from: 80
                color: '#8bc34a'
              - from: 90
                color: '#43a047'
          - type: gauge
            entity: sensor.smart_battery_charging_grid_dependency
            name: Grid Dependency
            unit: '%'
            needle: true
            min: 0
            max: 100
            segments:
              - from: 0
                color: '#43a047'
              - from: 20
                color: '#8bc34a'
              - from: 40
                color: '#fdd835'
              - from: 60
                color: '#fb8c00'
              - from: 80
                color: '#e53935'

      # ── Row 6: Charging Analytics ────────────────────────────────────────
      - type: grid
        cards:
          - type: glance
            title: Charging Analytics
            columns: 3
            show_state: true
            show_name: true
            entities:
              - entity: sensor.smart_battery_charging_morning_soc
                name: Morning SOC
                icon: mdi:battery-clock
              - entity: sensor.smart_battery_charging_planned_vs_actual_charge
                name: Actual Charge
                icon: mdi:chart-bar
              - entity: sensor.smart_battery_charging_weekly_charging_cost
                name: Weekly Cost
              - entity: sensor.smart_battery_charging_charging_savings
                name: Weekly Savings
              - entity: sensor.smart_battery_charging_bms_battery_capacity
                name: BMS Capacity

      # ── Row 7a: BMS Capacity Trend ───────────────────────────────────────
      - type: grid
        cards:
          - type: custom:apexcharts-card
            header:
              show: true
              title: BMS Battery Capacity
              show_states: true
              colorize_states: true
            graph_span: 30d
            span:
              end: day
            yaxis:
              - id: kwh
                apex_config:
                  title:
                    text: kWh
            series:
              - entity: sensor.smart_battery_charging_bms_battery_capacity
                name: Capacity
                type: line
                color: "#9c27b0"
                stroke_width: 2
                yaxis_id: kwh
                float_precision: 2
                group_by:
                  func: max
                  duration: 1d
                show:
                  in_header: raw

      # ── Row 7b: Charging Cost & Savings Trend ──────────────────────────────
      - type: grid
        cards:
          - type: custom:apexcharts-card
            header:
              show: true
              title: Charging Cost & Savings (30d)
              show_states: true
              colorize_states: true
            graph_span: 30d
            span:
              end: day
            yaxis:
              - id: cost
                min: 0
                apex_config:
                  title:
                    text: cost
            series:
              - entity: sensor.smart_battery_charging_weekly_charging_cost
                name: Weekly Cost
                type: line
                color: "#e91e63"
                stroke_width: 2
                yaxis_id: cost
                float_precision: 1
                group_by:
                  func: max
                  duration: 1d
                show:
                  in_header: raw
              - entity: sensor.smart_battery_charging_charging_savings
                name: Weekly Savings
                type: line
                color: "#4caf50"
                stroke_width: 2
                yaxis_id: cost
                float_precision: 1
                group_by:
                  func: max
                  duration: 1d
                show:
                  in_header: raw
